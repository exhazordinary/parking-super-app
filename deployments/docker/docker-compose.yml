# Docker Compose for local development
#
# MICROSERVICES PATTERN: Local Development Environment
# ====================================================
# This file sets up all the infrastructure needed for local development:
# - PostgreSQL database
# - Redis cache
# - Kafka message broker (optional)
#
# Usage:
#   docker-compose up -d       # Start all services
#   docker-compose down        # Stop all services
#   docker-compose logs -f     # View logs
#   docker-compose ps          # Check status

version: '3.8'

services:
  # ================================================
  # PostgreSQL - Primary database
  # ================================================
  # Each microservice should have its own database,
  # but for development we use one PostgreSQL instance
  # with separate databases.
  postgres:
    image: postgres:15-alpine
    container_name: parking-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      # Create multiple databases for different services
      POSTGRES_MULTIPLE_DATABASES: auth_db,wallet_db,provider_db,parking_db
    ports:
      - "5433:5432"  # Using 5433 externally since 5432 is in use
    volumes:
      # Persist data between container restarts
      - postgres_data:/var/lib/postgresql/data
      # Init script to create multiple databases
      - ./init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - parking-network

  # ================================================
  # Redis - Caching and session storage
  # ================================================
  # Used for:
  # - Rate limiting
  # - Session caching
  # - OTP storage (temporary)
  redis:
    image: redis:7-alpine
    container_name: parking-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - parking-network

  # ================================================
  # Kafka - Message broker (optional)
  # ================================================
  # Uncomment when you need async messaging
  # zookeeper:
  #   image: confluentinc/cp-zookeeper:7.5.0
  #   container_name: parking-zookeeper
  #   environment:
  #     ZOOKEEPER_CLIENT_PORT: 2181
  #   networks:
  #     - parking-network
  #
  # kafka:
  #   image: confluentinc/cp-kafka:7.5.0
  #   container_name: parking-kafka
  #   depends_on:
  #     - zookeeper
  #   ports:
  #     - "9092:9092"
  #   environment:
  #     KAFKA_BROKER_ID: 1
  #     KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
  #     KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
  #     KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
  #   networks:
  #     - parking-network

  # ================================================
  # Jaeger - Distributed tracing (optional)
  # ================================================
  # Uncomment when you need request tracing
  # jaeger:
  #   image: jaegertracing/all-in-one:1.50
  #   container_name: parking-jaeger
  #   ports:
  #     - "16686:16686"  # UI
  #     - "14268:14268"  # Collector
  #   networks:
  #     - parking-network

  # ================================================
  # Auth Service
  # ================================================
  # auth-service:
  #   build:
  #     context: ../../services/auth
  #     dockerfile: Dockerfile
  #   container_name: parking-auth
  #   ports:
  #     - "8081:8080"
  #   environment:
  #     SERVER_PORT: "8080"
  #     DB_HOST: postgres
  #     DB_PORT: "5432"
  #     DB_USER: postgres
  #     DB_PASSWORD: postgres
  #     DB_NAME: auth_db
  #     DB_SSLMODE: disable
  #     JWT_SECRET: dev-secret-key-change-in-production
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   networks:
  #     - parking-network

networks:
  parking-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
